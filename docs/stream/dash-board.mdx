---
sidebar_position: 2
description: 📌 모델 추론 결과를 모니터링 하는 대시보드를 구현 합니다.
---

# 2) Dashboard

### 목표

1. Grafana dashboard 를 통해 실시간으로 데이터를 모니터링 하는 대시보드를 작성합니다.
2. Grafana의 기본적인 사용 방법을 이해합니다.

<details>
<summary>스펙 명세서</summary>
<CodeDescription>

### 스펙 명세서

1. 실시간 모니터링 대시보드인 Grafana 를 정의하고 `docker compose` 를 활용해 서비스를 띄웁니다.
    - `GF_SECURITY_ADMIN_USER` : `dashboarduser`
    - `GF_SECURITY_ADMIN_PASSWORD` : `dashboardpassword`
    - `Port forwarding`
        - 3000:3000
2. `01. Database` 에서 띄웠던 DB 를 확인하고 Grafana 에서 시각화 합니다.
    - `host` : `postgres-server:5432`
    - `user` : `myuser`
    - `password` : `mypassword`
    - `database` : `mydatabase`
3. `07. Kafka` 에서 띄웠던 Target DB 를 확인하고 Grafana 에서 시각화 합니다.
    - `host` : `target-postgres-server:5432`
    - `user` : `targetuser`
    - `password` : `targetpassword`
    - `database` : `targetdatabase`

</CodeDescription>
</details>

---

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch8">

해당 파트의 전체 코드는 [mlops-for-mle/ch8/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch8) 에서 확인할 수 있습니다.

```js
ch8
├── Dockerfile
├── Makefile
├── README.md
├── data_subscriber.py
// highlight-next-line
├── grafana-docker-compose.yaml
└── stream-docker-compose.yaml
```

</BrowserWindow>

## 1. Grafana dashboard

Grafana 는 멀티플랫폼 오픈 소스 애널리틱스 및 인터랙티브 시각화 웹 애플리케이션입니다. 지원되는 데이터 소스에 연결될 때 웹의 차트, 그래프, 알람을 제공합니다.

Grafana 의 다양한 종류의 차트를 활용해 상황에 맞는 대시보드를 구현 할 수 있습니다. 또한 오픈소스이기 때문에 자체적인 Grafana 커뮤니티도 활성화 되어 필요한 정보나, 만들어진 대시보드를 활용 할 수도 있습니다. 또한 여러가지 데이터 소스로 부터 데이터를 받아 시각화 할 수 있습니다.

Grafana dashboard 는 [그림 8-x] 의 형태로 존재합니다.

- `dashboard` : 페이지 자체를 구성하고 전체 대시보드 제목, 새로고침 주기, 표시 할 기간 등을 정할 수 있습니다.
- `panel` : `dashboard` 안에 포함되어있는 차트를 의미하며 차트 제목, 차트 종류, 데이터 소스와 쿼리 등을 설정 할 수 있습니다.

### 1.1 Grafana Server setup

Grafana 의 스펙을 `grafana-docker-compose.yaml` 에 정의 합니다.

- 서비스의 이름은 `grafana-dashboard` 로 합니다.
- Grafana 에 로그인 하기위한 접속 정보를 환경 변수를 통해 설정 합니다.
- Grafana 의 dashboard panel 을 새로고침 하는 최소주기를 환경 변수를 통해 설정 합니다.

Grafana 는 메타 데이터를 관리하기 위한 Database 를 정의해서 사용 할 수 있습니다. 정의 되지 않은 경우 기본값으로 서버에 포함되어있는 SQLite3 를 사용 합니다. 이번에는 별도의 설정없이, 기본적으로 제공되는 SQLite3 를 사용 하겠습니다.

```yaml
version: "3"

services:
	grafana-dashboard:
		image: grafana/grafana
	  ports:
	   - 3000:3000
	  environment:
	    GF_SECURITY_ADMIN_USER: dashboarduser
	    GF_SECURITY_ADMIN_PASSWORD: dashboardpassword
	    GF_DASHBOARDS_MIN_REFRESH_INTERVAL: 500ms
```

- `image` : grafana 를 띄울 때 쓰이는 image 를 명시합니다. 여기서는 `grafana/grafana` 를 이용합니다.
- `ports` : grafana 의 port 를 지정합니다. 따로 정하지 않는 경우 내부적으로 3000 포트를 활용하기 때문에 외부 포트와의 연결에도 동일하게 `3000:3000` 으로 설정합니다.
- `environment` : grafana 에 들어갈 환경 변수를 설정합니다. grafana 는 [config 파일](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/)로 `grafana.ini` 를 사용합니다. 해당 config 파일을 설정하거나 규칙에 맞춰 환경 변수를 활용하여 grafana 를 설정 할 수 있습니다. [환경변수를 활용 할 경우 규칙](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#override-configuration-with-environment-variables)은 `GF_<SectionName>_<KeyName>` 입니다. 이번 장에서는 환경변수를 사용해 접속 정보와 최소 새로고침 주기를 커스터마이징 해보겠습니다.
    - `GF_SECURITY_ADMIN_USER` : grafana 에 접속하기 위한 admin 유저의 접속 아이디 입니다. 설정하지 않는 경우 기본값은 `admin` 입니다. 여기서에서는 `dashboarduser` 라는 값으로 설정 하겠습니다.
    - `GF_SECURITY_ADMIN_PASSWORD` : grafana 에 접속하기 위한 admin 유저의 접속 패스워드 입니다. 설정하지 않는 경우 기본값은 `admin` 입니다. 여기서에서는 `dashboardpassword` 라는 값으로 설정 하겠습니다.
    - `GF_DASHBOARDS_MIN_REFRESH_INTERVAL` : grafana 에서 대시보드를 만들 때 실시간으로 패널들을 그리기 위한 새로고침이 필요하게 되는데, 해당 주기의 최소값을 변경합니다. 설정하지 않는 경우 `5s` 의 값을 가지며, 5초 이하의 주기로 새로고침 하도록 설정을 할 수 없게 됩니다.

### 1.2 Network setup

```yaml
networks:
  default:
    name: mlops-network
    external: true
```

**TBD: 종섭님이 넣어주시면 복붙 할 것**

### 1.3 Grafana docker compose

- 작성한 내용을 하나로 모으면 다음과 같습니다.

`**grafana-docker-compose.yaml**`

```yaml
version: "3"

services:
	grafana-dashboard:
		image: grafana/grafana
	  ports:
	   - 3000:3000
	  environment:
	    GF_SECURITY_ADMIN_USER: dashboarduser
	    GF_SECURITY_ADMIN_PASSWORD: dashboardpassword
	    GF_DASHBOARDS_MIN_REFRESH_INTERVAL: 500ms

networks:
  default:
    name: mlops-network
    external: true
```

### 1.4 Grafana Server 띄우기

- 완성된 파일을 통해 Grafana server 를 띄웁니다.
- 앞 장의 data-subscriber 와는 독립적인 서비스이기 때문에 `-p` 옵션으로 프로젝트 이름을, `-f` 옵션으로 사용하고자 하는 파일을 명시해 줍니다.

```bash
$ docker compose -p ch8-dashboard -f stream-docker-compose.yaml up -d
```

### 1.2 Grafana Dashboard 만들기

- 서비스가 띄워졌다면, [localhost:3000](http://localhost:3000) 을 통해 grafana에 접속하여 설정했던 아이디와 패스워드로 접속합니다.
- 접속이 잘 되었다면 왼쪽 사이드바의 `네모 모양 > New dashboard` 버튼을 눌러줍니다.
- 먼저 Dashboard 에 대한 설정을 해보겠습니다.
    - 오른쪽 위의 톱니바퀴 ⚙️ 버튼을 클릭합니다.
    - 대시보드의 정보들을 설정합니다.
        - `General` 필드에서 이름, 명세, 태그 등의 정보를 기록 할 수 있습니다.
        - 대시보드의 이름은 `Iris classification` 으로 합니다.
        - `Time options` 필드에서 시간대, 한 주의 시작 등의 정보를 정할 수 있습니다.
        - `Auto refresh` 영역에 `1s,` 를 추가하여 다음과 같이 만들어 줍니다.
        - `Refresh live dashboards` 토글을 클릭해 실시간으로 패널이 업데이트 되도록 해줍니다.
        - 오른쪽 위의 `Save dashboard` 버튼을 클릭하고, `General` 폴더에 저장합니다.

## 2. Source database 그리기

### 2.1 Data source 연결하기

- 왼쪽 아래 톱니바퀴 `⚙️ 버튼 > Data sources` 를 클릭합니다.
- `Add data source` 버튼을 클릭하고, PostgreSQL 을 검색하여 클릭합니다.
- 데이터 소스의 이름, `01. Database` 에서 띄워 두었던 원본 데이터 베이스의 정보를 입력합니다. `Default` 로 체크되어있는 토글은 해제해 줍니다. 작성이 끝나고 `Save & test` 버튼을 누릅니다.
    - `Host` : `postgres-server:5432`
    - `Database` : `mydatabase`
    - `User` : `myuser`
    - `Password` : `mypassword`
    - `TLS/SSL Mode` : `disable`
    - `Version` : `14.0`
- 데이터 소스 연결이 성공하면 `Database Connection OK` 라는 문구가 나타납니다.

### 2.2 Panel 만들기

- `네모 모양 > Browse` 를 클릭하여 다음 화면으로 이동합니다.
- 그러면 아까 만들어 두었던 `Iris classification` dashboard 를 확인 할 수 있습니다. 클릭하여 이동합니다.
- 이제 우측 상단의 차트 📊 버튼을 클릭하여 패널을 생성 합니다.
- 생성된 패널에서 `Add a new panel` 옵션을 선택합니다.
- 패널의 정보를 설정합니다.
    - Information - 패널의 이름, 차트의 종류 등을 설정 합니다.
        - 기본 값으로 `Time series` 차트가 설정되어 있습니다.
        - 오른쪽 탭의 `Title` 에 패널의 이름을 붙여줍니다. 여기서는, `Iris source data` 라고 설정하겠습니다.
    - Query - 데이터 베이스에서 시각화 할 테이블 및 열 정보를 설정합니다.
        - `Data source` : *`위에서 설정한 이름`*
        - `Table` : `iris_data`
        - `Column` : ➕ 버튼을 눌러 시각화 대상의 column 을 추가합니다.
            - `timestamp`
            - `sepal_length`
            - `sepal_width`
            - `petal_length`
            - `petal_width`
        - `Run query` 버튼 오른쪽의 `Code` 버튼을 클릭하고 `Limit` 부분을 지워줍니다.
        - `Run query` 버튼을 클릭합니다.
- 작업이 마무리 되었으면 오른쪽 위의 `Save` 버튼을 통해 패널을 저장합니다.
- 저장이 완료되면 왼쪽 위의 화살표 ⬅️ 버튼을 눌러 뒤로 이동합니다.
- 이제 대시보드의 패널 새로고침 주기 및 패널 시각화 기간을 설정합니다.
    - 오른쪽 위의 `🕙 Last 6 hours` 를 클릭하여 패널에 시각화 할 기간을 명세합니다.
    - 1초 단위로 데이터가 생성 되기 때문에, 30초를 모니터링 하기 위해서 `From` 부분을 `now-30s` 로 바꿔주겠습니다. 바꾸고 난 다음 `Apply time range` 버튼을 클릭 합니다.
    - 오른쪽 위의 🔄 버튼을 누르고 설정했던 `1s` 를 클릭합니다.
- 실시간 모니터링을 확인하고 수정된 dashboard 를 오른쪽 위의 💾 버튼을 클릭하여 저장합니다.
    - 저장시에 **`save current time range as dashboard default`** 를 체크 합니다.

## 3. Inference database 그리기

2. Source database 그리기 에서 했던 내용을 반복합니다.

### 3.1 Data source 연결하기

- 왼쪽 아래 톱니바퀴 `⚙️ 버튼 > Data sources` 를 클릭합니다.
- `Add data source` 버튼을 클릭하고, PostgreSQL 을 검색하여 클릭합니다.
- 데이터 소스의 이름, `01. Database` 에서 띄워 두었던 원본 데이터 베이스의 정보를 입력합니다. `Default` 로 체크되어있는 토글은 해제해 줍니다. 작성이 끝나고 `Save & test` 버튼을 누릅니다.
    - `Host` : `target-postgres-server:5432`
    - `Database` : `targetdatabase`
    - `User` : `targetuser`
    - `Password` : `targetpassword`
    - `TLS/SSL Mode` : `disable`
    - `Version` : `14.0`
- 데이터 소스 연결이 성공하면 `Database Connection OK` 라는 문구가 나타납니다.

### 2.1 Panel 만들기

- `네모 모양 > Browse` 를 클릭하여 다음 화면으로 이동합니다.
- `Iris classification` dashboard 클릭하여 이동합니다.
- 완성해 두었던 `Iris source data` 패널을 확인하고, 오른쪽 상단의 차트 📊 버튼을 클릭하여 패널을 생성 합니다.
- 생성된 패널에서 `Add a new panel` 옵션을 선택합니다.
- 패널의 정보를 설정합니다.
    - Information - 패널의 이름, 차트의 종류 등을 설정 합니다.
        - 기본 값으로 `Time series` 차트가 설정되어 있습니다.
        - 오른쪽 탭의 `Title` 에 패널의 이름을 붙여줍니다. 여기서는, `Iris inference result` 라고 설정하겠습니다.
    - Query - 데이터 베이스에서 시각화 할 테이블 및 열 정보를 설정합니다.
        - `Data source` : *`위에서 설정한 이름`*
        - `Table` : `iris_prediction`
        - `Column` : ➕ 버튼을 눌러 시각화 대상의 column 을 추가합니다.
            - `timestamp`
            - `iris_class`
        - `Run query` 버튼 오른쪽의 `Code` 버튼을 클릭하고 `Limit` 부분을 지워줍니다.
        - `Run query` 버튼을 클릭합니다.
- 작업이 마무리 되었으면 오른쪽 위의 `Save` 버튼을 통해 패널을 저장합니다.
- 저장이 완료되면 왼쪽 위의 화살표 ⬅️ 버튼을 눌러 뒤로 이동합니다.
